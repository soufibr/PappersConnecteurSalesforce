<template>
    <div class="modal-container">
        <div class="search-bar-container">
            <!-- Conteneur du champ de recherche -->
            <div class="search-input-container">
                <lightning-icon 
                    icon-name="utility:search" 
                    alternative-text="Search" 
                    size="small" 
                    class="search-icon">
                </lightning-icon>
                <input
                    type="text"
                    class="search-input"
                    placeholder={placeholder}
                    oninput={handleInputChange}
                />
            </div>
            
            <!-- Conteneur du dropdown -->
            <div class="filter-button-container">
                <lightning-combobox
                    name="filterOptions"
                    label="Rechercher par"
                    value={currentFilter}
                    placeholder="Nom, SIREN, SIRET"
                    options={filters}
                    onchange={changeFilter}
                >
                </lightning-combobox>
            </div>
        </div>
    </div>
    

    <template if:true={values.length}>
        <ul class="suggestions-list">
            <template for:each={values} for:item="item">
                <li key={item.key} data-siren={item.siren} class="list-item" onclick={fetchEstablishments}>
                    <template if:true={item.existsInAccount}>
                        <span class="existing-account">{item.value}</span>
                    </template>
                    <template if:false={item.existsInAccount}>
                        <span>{item.value}</span>
                    </template>
                    <template if:true={item.existsInAccount}>
                        <lightning-icon 
                            icon-name="utility:check" 
                            alternative-text="Ce Compte existe déjà" 
                            size="x-small" 
                            class="existing-account-icon" 
                            title="Ce Compte existe déjà">
                        </lightning-icon>
                    </template>
    
                    <!-- Nested list for établissements -->
                    <template if:true={item.etablissements}>
                        <ul class="nested-list">
                            <template for:each={item.etablissements} for:item="etablissement">
                                <li 
                                    key={etablissement.siret} 
                                    data-siret={etablissement.siret} 
                                    onclick={handleEtablissementClick} 
                                    class="nested-list-item"
                                >
                                <span class="icon-and-details">
                                    <!-- SVG Building Icon -->
                                    <span class="building-icon">
                                        <svg 
                                            width="20" 
                                            height="20" 
                                            xmlns="http://www.w3.org/2000/svg" 
                                            fill-rule="evenodd" 
                                            clip-rule="evenodd"
                                        >
                                            <path d="M1 22h2v-22h18v22h2v2h-22v-2zm7-3v4h3v-4h-3zm5 0v4h3v-4h-3zm-6-5h-2v2h2v-2zm8 0h-2v2h2v-2zm-4 0h-2v2h2v-2zm8 0h-2v2h2v-2zm-12-4h-2v2h2v-2zm8 0h-2v2h2v-2zm-4 0h-2v2h2v-2zm8 0h-2v2h2v-2zm-12-4h-2v2h2v-2zm8 0h-2v2h2v-2zm-4 0h-2v2h2v-2zm8 0h-2v2h2v-2zm-12-4h-2v2h2v-2zm8 0h-2v2h2v-2zm-4 0h-2v2h2v-2zm8 0h-2v2h2v-2z"/>
                                        </svg>
                                    </span>
                
                                    <!-- Establishment Details -->
                                    <template if:false={etablissement.existsInSalesforce}>
                                        <span>
                                            <template if:true={etablissement.siege}>
                                                <strong>Siège</strong>
                                            </template>
                                            <template if:false={etablissement.siege}>
                                                <strong>Établissement secondaire</strong>
                                            </template>
                                            <br />
                                            <strong>{etablissement.siret_formate}</strong> - 
                                            {etablissement.adresse_ligne_1}, {etablissement.ville}
                                            
                                        </span>
                                    </template>
                                    
                                    <template if:true={etablissement.existsInSalesforce}>
                                        <span class="existing-account">
                                            <template if:true={etablissement.siege}>
                                                <strong>Siège</strong>
                                            </template>
                                            <template if:false={etablissement.siege}>
                                                <strong>Établissement secondaire</strong>
                                            </template>
                                            <br />
                                            <strong>{etablissement.siret_formate}</strong> - 
                                            {etablissement.adresse_ligne_1}, {etablissement.ville}
                                            <lightning-icon 
                                                icon-name="utility:check" 
                                                alternative-text="Ce Compte existe déjà" 
                                                size="x-small" 
                                                class="existing-account-icon" 
                                                title="Ce Compte existe déjà">
                                            </lightning-icon>
                                        </span>
                                    </template>
                                </span>
                                </li>
                            </template>
                        </ul>
                    </template>
                </li>
            </template>
        </ul>
    </template>
    
    <!-- Suggestions for addresses -->
    <template if:true={showAddressSuggestions}>
        <ul class="suggestions-list">
            <template for:each={autocompleteValues} for:item="address">
                <li 
                    key={address.key} 
                    data-value={address.value} 
                    onclick={handleAddressSelection} 
                    class="list-item"
                >
                    {address.label}
                </li>
            </template>
        </ul>
    </template>



  
    


    <!-- Affichage des détails de l'entreprise -->
    <template if:true={companyDetails}>
        <!-- Barre supérieure avec mise à jour -->
        <div class="top-bar">
            <div class="top-bar-content">
                <span>Mise à jour RCS : le {rcsUpdate}</span>
                <span>Mise à jour INSEE : le {inseeUpdate}</span>
            </div>
        </div>

        <!-- Conteneur principal -->
        <div class="main-container slds-m-top_medium">
            <!-- Informations sur l'entreprise -->
            <div class="company-info">
                <h1 class="company-name">{companyDetails.nom_entreprise} <template if:true={selectedEstablishment}>{selectedEstablishment.ville}</template></h1>
                   
                
                <div class="company-status">
                    <span class="siren">{companyDetails.siren_formate}</span>
                    <span class="dot-separator">·</span>
                    <span class="status active">{companyStatus}
                        <lightning-icon icon-name="utility:success" alternative-text="Active" size="xx-small"></lightning-icon>
                    </span>
                </div>

                <!-- Tableau des informations -->
                <div class="table-container">
                    <table>
                        <tbody>
                            <tr>
                                <th>Adresse :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        {selectedEstablishment.adresse_ligne_1}, {selectedEstablishment.ville}, {selectedEstablishment.code_postal}, {selectedEstablishment.pays}
                                    </template>
                                    <template if:false={selectedEstablishment}>
                                        {siegeAddress}
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <th>SIRET :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        {selectedEstablishment.siret_formate}
                                    </template>
                                    <template if:false={selectedEstablishment}>
                                        {companyDetails.siret_formate}
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <th>Date de création :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        {selectedEstablishment.date_de_creation}
                                    </template>
                                    <template if:false={selectedEstablishment}>
                                        {companyDetails.date_creation_formate}
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <th>Effectif :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        {selectedEstablishment.effectif}
                                    </template>
                                    <template if:false={selectedEstablishment}>
                                        {companyDetails.effectif}
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <th>Activité :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        {selectedEstablishment.libelle_code_naf}
                                    </template>
                                    <template if:false={selectedEstablishment}>
                                        {companyDetails.libelle_code_naf}
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <th>Carte :</th>
                                <td>
                                    <template if:true={selectedEstablishment}>
                                        <lightning-map
                                            map-markers={mapMarkers}
                                            zoom-level="15"
                                            selected-marker-value={selectedMarkerValue}>
                                        </lightning-map>
                                    </template>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <template if:true={selectedEstablishment}>
                    <template if:true={selectedEstablishment.existsInSalesforce}>
                        <lightning-button 
                            label="Mettre à jour le compte" 
                            icon-name="utility:refresh" 
                            class="action-button update-button" 
                            onclick={handleUpdateAccount}>
                        </lightning-button>
                    </template>
                    <template if:false={selectedEstablishment.existsInSalesforce}>
                        <lightning-button 
                            label="Créer ce compte" 
                            icon-name="utility:record_create" 
                            class="action-button create-button" 
                            onclick={handleCreateAccount}>
                        </lightning-button>
                    </template>
                </template>
            </div>

        </div>
    </template>
		
</template>